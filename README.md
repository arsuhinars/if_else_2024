# История погоды
Сервис для предоставляет централизованную базу данных метеорологических записей,
обеспечивая доступ к историческим данным для долгосрочных исследований
климатических паттернов и улучшения точности прогнозов погоды.

Телеграм разработчика: [@arsuhinars](https://t.me/arsuhinars)

Цели и задачи:
- Создание централизованной базы данных метеорологических записей
- Объединение всех исторических данных для долгосрочных исследований
климатических паттернов
- Использование данных для изучения климатических изменений
- Помощь в сельском хозяйстве через предоставление информации о погодных условиях

Реализованные возможности:
- Регистрация аккаунтов и авторизация
- Функционал по обработке аккаунтов (поиск по критериям, обновление, удаление)
- Создание, обновление и удаление регионов и их типов
- Возможность добавления/удаления текущей погоды, поиска всех записей о погоде
в регионах
- Также функционал по работе с прогнозами погодами (добавление, обновление, 
удаление, привязка к погоде)

## Установка и запуск
1. Убедитесь, что у вас в системе установлен [Docker](https://www.docker.com/)
2. Склонируйте данный репозиторий:
```shell
git clone https://gitverse.ru/arsuhinars/IT-Planet_If_else_Fedorov
```
3. Перейдите в директорию репозитория и запустите сервер:
```shell
docker compose up -d --build
```
4. По умолчанию, сервер будет доступен по адресу `http://localhost:8080`
5. Остановка сервера:
```shell
docker compose down
```

## Документация
OpenAPI документация доступна в файле [`openapi.json`](./openapi.json). При
запущенном сервере вы можете открыть Swagger по адресу http://localhost:8080/docs

Формат файла `.env`, который используется для конфигурации сервера:
```text
SERVER_PORT=8080                    # Порт сервера
SERVER_URL=http://localhost:8080    # Адрес сервера (для отладки в Swagger)
# URL для доступа к БД
DB_URL=postgresql+psycopg://user:qwerty12@database:5432/if_else_2024
CREATE_FAKE_DATA=false              # Нужно ли создавать фейковые данные (для удобства отладки)

POSTGRES_DATABASE=if_else_2024      # Название БД
POSTGRES_USER=user                  # Имя пользователя в БД
POSTGRES_PASSWORD=qwerty12          # Пароль пользователя в БД
```

## Архитектура и стек
Стек: Python, FastAPI, SQLAlchemy, Docker, PostgreSQL

Код проекта разделен на несколько основных модулей:
- `core` - инициализация БД, установка зависимостей, настройка сервера
- `auth` - регистрация и авторизация
- `accounts` - функционал по работе с аккаунтами
- `regions` - регионы
- `forecasts` - прогнозы погоды
- `weather` - погода

Архитектура проекта состоит из нескольких слоев (от верхних к нижним):
1. __Контроллеры__ (`routers`) - занимается обработкой запросов от клиента,
валидацией данных, аутентификацией и авторизацией, а также формированием
ответа.
2. __Сервисы__ (`services`) - организуют всю бизнес-логику сервиса
3. __Репозитории__ (`repositories`) - обеспечивают доступ к данным в БД
4. __Модели__ (`models`) - представляют данные, хранящиеся в базе данных

Также некоторые модули могут содержать следующие подмодули:
- `dto` - содержит классы DTO (Data Transfer Objects), которые используются для
передачи данных между разными слоями приложения.
- `dependencies` - содержит зависимости для FastAPI
- `utils` - различные утилитарные классы и функции

Описание подмодулей в модуле `core`:
- `settings` - содержит класс `AppSettings` со всеми настройками сервера
- `exceptions` - содержит классы исключений, используемые для описания
ошибок, возникающих в ходе работы самого сервиса. Все они наследуются от
основного класса - `AppException`. Также в этом модуле имеются функции для
обработки этих ошибок и формирования ответа клиенту с текстом и кодом ошибки.
- `db_manager` - содержит класс `DbManager`, который занимается подключением к
БД, инициализацией таблиц и созданием сессий.
- `setup` - модуль, содержащий фабрику экземпляров приложения `FastAPI`.
Внутри он устанавливает все зависимости между классами, подключает все роутеры и
обработчики исключений.

Для авторизации используются сессии. Пользователь сначала регистрирует свой
аккаунт при помощи метода `POST /registration`, авторизуется на сервисе
при помощи `GET /login`. Данный метод устанавливает в Cookie параметр `id`
уникальный UUID сессии. При повторной авторизации, прошлая сессия становиться
неактивной. Данная сессия существует некоторое время, после которого она
также будет неактивной (время конфигурируется в `AppSettings.auth_session_lifetime`
в секундах).

Схема базы данных:<br>
<img src="./db_schema.png" height="400">

Проект включает в себя два Docker-контейнера: `server` и `database`. Первый
является самим сервером, второй базой данных PostgreSQL.

Сборка контейнера сервера происходит в два этапа: установка зависимостей и
запуск приложения. Для запуска приложения с отладчиком выделена отдельная стадия.

Для удобства отладки в отдельный Compose-файл был добавлен контейнер с
`pgadmin` - инструмент для администрирования базы данных, а также в `.env`
файле параметром `CREATE_FAKE_DATA` можно включить автоматическую генерацию
фейковых данных. В `if_else_2024.core.settings` в классе `AppSettings` можно
изменить количество создаваемых записей.
